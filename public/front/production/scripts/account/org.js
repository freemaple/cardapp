require(["jquery","validate","mylayer","tree"],function(e,r,o,a){var t={};t.init=function(){e.validator.addMethod("phone",function(e,r){var o=/^[()+0-9_\-\s]*$/;return this.optional(r)||o.test(e)},e.tran("valid.valid_phone","请输入正确的电话号码")),this.orgJoinEvent(),this.orgEdit(),this.teacherInit(),this.orderEvent(),this.courseSetting(),e.validatorMessageConfig();var r="undefined"==typeof treeCategory?[]:treeCategory;e("#course_category_tree").tree({data:r});var a=e("#course_category_tree");a.bind("tree.select",function(r){if(r.node){var o=r.node;e(".course_category_id").val(o.id),e(".course_category_name").val(o.name);var a=e(".course_category_tree_box");a.hide()}}),e(".course_category_name").on("click",function(){var r=e(".course_category_tree_box");r.is(":hidden")?r.show():r.hide()});var t=e(".course_category_id").val();if(t){var i=a.tree("getNodeById",t);a.tree("selectNode",i)}e("body").on("click",function(r){var o=r||window.event,a=e(o.target||o.srcElement);if(!a.hasClass("course_category_tree_box")&&0==a.closest(".course_category_tree_box").size()&&!a.hasClass("course_category_name")){var t=e(".course_category_tree_box");t.hide()}}),e(".image_file_select").off("change").on("change",function(){try{var r=e(this),a=r[0].files;if(a&&a.length>0){if(!a[0].type||e.inArray(a[0].type,["image/png","image/jpg","image/jpeg","image/gif"])==-1)return o.showMessage("error","请检查图片格式，只能上传png/jpg/gif image"),!1;var t=a[0].size;if(t=t/1024/1024,t>2)return o.showMessage("error","请上传小于3M的图片"),!1}}catch(e){}})},t.orgJoinEvent=function(){e(".org_nav").click(function(){var r=e(this);if(r.hasClass("disabled"))return!1;var o=e(this).attr("data-nav");e(this).addClass("current").siblings(".org_nav").removeClass("current"),e(".org_panel").hide(),e(".org_panel_"+o).show()}),e(".show_org_next").on("click",function(){e(".org_nav.current").removeClass("current").next(".org_nav").addClass("current"),e(".org_panel:visible").hide().next(".org_panel").show();var r=e(".org_box").offset().top-100;window.scrollTo(0,r)}),e(".org_join_form").validate(this.orgValid),e(".submit_org_info").on("click",function(){var r=e(this);if(r.hasClass("disabled"))return!1;var o=e(".org_join_form");o.valid()&&(o.submit(),r.addClass("disabled"))})},t.orgEdit=function(){var r=this;e(".organization_image").on("click",function(){e(".organization_image_file").click()}),e(".organization_image_file").off("change").on("change",function(){try{var a=e(this),t=a[0].files;if(t&&t.length>0){if(!t[0].type||e.inArray(t[0].type,["image/png","image/jpg","image/jpeg","image/gif"])==-1)return o.showMessage("error","请检查图片格式，只能上传png/jpg/gif image"),!1;var i=t[0].size;if(i=i/1024/1024,i>3)return o.showMessage("error","请上传小于3M的图片"),!1}r.uploadOrganizationBanner({elem:a})}catch(e){}}),e(".show_org_info_box").on("click",function(){e(".org_form_box").hide();var r=e(".org_info_box");r.is(":hidden")&&r.show();var o=r.offset().top-100;window.scrollTo(0,o)}),e(".hide_org_info_box").on("click",function(){var r=e(".org_info_box");r.hide();var o=e(".org_block").offset().top-100;window.scrollTo(0,o)}),e(".show_org_setting_box").on("click",function(){e(".org_form_box").hide();var r=e(".org_setting_box");r.is(":hidden")&&r.show();var o=r.offset().top-100;window.scrollTo(0,o)}),e(".hide_org_setting_box").on("click",function(){var r=e(".org_setting_box");r.hide();var o=e(".org_block").offset().top-100;window.scrollTo(0,o)}),e(".org_info_form").validate(this.orgUpdateValid),e(".update_org_info_box").on("click",function(){var a=e(".org_info_form");if(a.valid()){var t=a.serializeObject();r.updateOrganization(t,function(e){"200"==e.code&&o.showMessage("success",e.message,function(){window.location.href=window.location.href})})}}),e(".public_org").on("click",function(){var r=e(this),o=e(".update_public_org_alert"),a=r.is(":checked")?"1":"0",t={public:a};return o.html(""),e.postForm(r,"/api/organization/update",t,function(e){"200"==e.code?(o.html("<span class='text_success'>"+e.message+"</span>"),o.show().delay(3e3).hide(0),"1"==a?r.prop("checked","checked"):r.removeAttr("checked")):e.message&&(o.html("<span class='text_red'>"+e.message+"</span>"),o.show().delay(3e3).hide(0))}),!1}),e(".online_org").on("click",function(){var r=e(this),o=e(".update_off_org_alert"),a=r.is(":checked")?"1":"0",t={online:a};return o.html(""),e.postForm(r,"/api/organization/update",t,function(e){"200"==e.code?(o.html("<span class='text_success'>"+e.message+"</span>"),o.show().delay(3e3).hide(0),"1"==a?r.prop("checked","checked"):r.removeAttr("checked")):e.message&&(o.html("<span class='text_red'>"+e.message+"</span>"),o.show().delay(3e3).hide(0))},"json"),!1}),e("#course_description_editor").size()>0&&require(["wangEditor"],function(r){e.descriptionEditor(r,"course_description_editor")}),e("#organization_description_editor").size()>0&&require(["wangEditor"],function(r){e.descriptionEditor(r,"organization_description_editor")}),e(".organization_submit_approval").on("click",function(){var r=e(this);e.postForm(r,"/api/organization/submitApproval",{},function(e){"200"==e.code?o.showMessage("success","已提交审核，请耐心等待！",function(){window.location.reload()}):o.showMessage("error",e.message)})})},t.courseSetting=function(){e(".add_course_form").validate(this.addcourseValid),e(".edit_course_form").validate(this.editcourseValid),e(".public_course").on("click",function(){var r=e(this),o=r.attr("data-id"),a=e(".update_public_alert"),t=r.is(":checked")?"1":"0",i={public:t};return a.html(""),e.postForm(r,"/account/organization/course/setting/"+o,i,function(e){"200"==e.code?(a.html("<span class='text_success'>"+e.message+"</span>"),a.show().delay(3e3).hide(0),"1"==t?r.prop("checked","checked"):r.removeAttr("checked")):e.message&&(a.html("<span class='text_red'>"+e.message+"</span>"),a.show().delay(3e3).hide(0))}),!1}),e(".online_course").on("click",function(){var r=e(this),o=r.attr("data-id"),a=e(".update_off_alert"),t=r.is(":checked")?"1":"0",i={online:t};return a.html(""),e.postForm(r,"/account/organization/course/setting/"+o,i,function(e){"200"==e.code?(a.html("<span class='text_success'>"+e.message+"</span>"),a.show().delay(3e3).hide(0),"1"==t?r.prop("checked","checked"):r.removeAttr("checked")):e.message&&(a.html("<span class='text_red'>"+e.message+"</span>"),a.show().delay(3e3).hide(0))},"json"),!1})},t.orgValid={rules:{name:{required:!0,maxlength:50},banner:{required:!0,accept:""},address:{required:!0,maxlength:255},creation_time:{required:!0,maxlength:50},business_hours:{required:!0,maxlength:255},contact_phone:{required:!0,phone:!0,maxlength:50},contact_user_name:{required:!0,maxlength:50},busines_license_number:{required:!0,maxlength:50},busines_license_image:{required:!0,accept:""}}},t.orgUpdateValid={rules:{name:{required:!0,maxlength:50},address:{required:!0,maxlength:255},creation_time:{required:!0,maxlength:50},contact_phone:{required:!0,phone:!0,maxlength:50},contact_user_name:{required:!0,maxlength:50},busines_license_number:{required:!0,maxlength:50}}},t.addcourseValid={rules:{name:{required:!0,maxlength:50},banner:{required:!0,accept:""},price:{required:!0,number:!0},special:{number:!0},class_number:{required:!0,digits:!0,min:1},description:{required:!0}}},t.editcourseValid={rules:{name:{required:!0,maxlength:50},banner:{accept:""},price:{required:!0,number:!0},special:{number:!0},class_number:{required:!0,digits:!0,min:1},description:{required:!0}}},t.setForm=function(r,o){var a,t=r.find("[name]");t.each(function(r){a=e.trim(e(this).attr("name")),e(this).hasClass("check")&&(o[a]?e(this).prop("checked","checked"):e(this).removeAttr("checked")),e(this).is("select")?e(this).find('option[value="'+o[a]+'"]').prop("selected","selected"):e(this).val(o[a]?o[a]:"")})},t.updateOrganization=function(r,o){e.post("/api/organization/update",r,function(e){"function"==typeof o&&o(e)},"json")},t.teacherInit=function(){var r=this;e(".hide_teacher_layer").on("click",function(){e(".teacher_layer").removeClass("show"),e(".teacher_layer_box").removeClass("show"),e(".teacher_layer_overlay").hide(),e("html,body").css("overflow-y","auto")}),e(".add_teacher").on("click",function(e){var o={status:"1",type:"1"};r.initTeacherLayer(o)}),e(".edit_tearcher").on("click",function(){var o=e(this),a=o.attr("data-id");e.postForm(o,"/api/organization/teacher/load",{teacher_id:a},function(e){if("200"==e.code){var o=e.data;o.type="2",r.initTeacherLayer(o)}})}),e(".teacher_info_form").validate(this.teacherValid),e(".teacher_info_form").on("click",function(r){var a=e(this),t=r||window.event,i=e(t.target||t.srcElement);if(i.hasClass("save_teacher")&&a.valid()){var s=a.serializeObject();e.postForm(i,"/api/organization/teacher/save",s,function(e){"200"==e.code?o.showMessage("success",e.message,function(){window.location.reload()}):e.message&&o.showMessage("success",e.message)})}}),e(".show_org_order_teacher").on("click",function(){var r=e(this).attr("order-id");e.post("/api/organization/order/teacher",{},function(a){"200"==a.code&&o.init({title:"教师分配",content:a.view,class_name:"org_order_teacher_layer",layerClose:!1,success:function(){e(".order_teacher_syn_form").on("click",function(){var a=e(this),t=event||window.event,i=e(t.target||t.srcElement);if(i.hasClass("update_order_teacher")&&a.valid()){var s=a.serializeObject();s.order_id=r,e.postForm(i,"/api/organization/order/teacher/syn",s,function(e){"200"==e.code?o.showMessage("success",e.message,function(){window.location.reload()}):e.message&&o.showMessage("success",e.message)})}})}})},"json")})},t.teacherValid={rules:{fullname:{required:!0,maxlength:50},phone:{required:!0,phone:!0,maxlength:50}}},t.initTeacherLayer=function(r){e(".teacher_layer_overlay").show(),e(".teacher_layer").addClass("show"),e(".teacher_layer_box").addClass("show"),e("html,body").css("overflow-y","hidden");var a=e(".teacher_layer_box").find(".layerBox_wrapper");a.css({left:"50%","margin-left":"-"+a.width()/2+"px"});var t=o.getWinHeight();if(a.height()<t?a.css({top:"50%","margin-top":"-"+a.height()/2+"px"}):a.css({top:"10px","margin-top":"0px"}),r){var i=e(".teacher_info_form");this.setForm(i,r)}},t.orderEvent=function(){e(".update_order_record_status").on("click",function(){var r=e(this),a=e(this).attr("data-id"),t=e(this).attr("data-status"),i={order_record_id:a,status:t};e.postForm(r,"/api/organization/order/record/updatestatus",i,function(e){"200"==e.code?o.showMessage("success",e.message,function(){window.location.reload()}):o.showMessage("error",e.message)})}),e(".load_course_record_review").on("click",function(){var r=e(this),a=e(this).attr("order-id"),t=e(this).attr("data-id"),i={};i.order_id=a,i.course_record_id=t,e.postForm(r,"/api/course/order/record/review/load",i,function(r){if("200"==r.code){var a=e(".review_layer").html();o.init({title:"课程评论",content:a,no_remove:!0,class_name:"course_record_review_layer",layerClose:!1,success:function(){e(".review_form").find(".submit_review").hide(),e(".review_form").find(".score_value").val(r.data.score),e(".review_form").find(".content_value").val(r.data.content),r.data.score>5&&(r.data.score=5),e(".score_value").val(r.data.score),e(".score_value_text").text(r.data.score);var o=e(".review_form").find(".score_value_s").width();e(".review_form").find(".review_s_value").width(r.data.score/5*o)}})}else o.showMessage("error",r.message)})})},t.uploadOrganizationBanner=function(e){if(e&&e.elem)var r=e.elem.parent();if(r&&r.size()>0){var a={},t={type:"POST",url:"/api/organization/uploadBanner",dataType:"json",data:a,success:function(e){"200"==e.code?window.location.reload():e.message&&o.showMessage("error",e.message)},error:function(){o.showMessage("error","Oh~ damn it,Please be patient and I'm trying to speed up.")},resetForm:!0};require(["ajaxForm"],function(e){r.ajaxForm(t),r.submit()})}},e(function(){t.init()})});