require(["jquery","lazyload","validate","mylayer","loginReg"],function(t,e,a,n,o){var i={};i.init=function(){this.basket_number=t.trim(t("#basket_number").val()),t(".lazyload").lazyload({threshold:-100}),this.contactEvent(),this.checkoutEvent(),t.validatorMessageConfig(),t(".layer_login.is_show").size()>0&&o.showLogin()},i.checkoutEvent=function(){var e=this;t(".payment_list").on("click",function(e){var a=t(this),n=e||window.event,o=t(n.target||n.srcElement);if(o.hasClass("payment_item"))var i=o;else var i=o.closest(".payment_item");if(i.size()>0){var s=i.find(".payment_method_check");a.find(".shipping_method_check").removeAttr("checked"),s.prop("checked","checked")}}),t(".order_submit").on("click",function(){t(this);return!t(this).hasClass("disabled")&&void n.showConfirm("您是否确定申请此课程？",function(){var a="",n=t(".payment_method_check:checked");n.size()>0&&(a=n.attr("data-code")),e.checkoutSubmit()})})},i.checkoutSubmit=function(){var e=this,a=!0,n=t.trim(t(".contact_fullname").text()),o=t.trim(t(".contact_phone").text()),i=t.trim(t(".family_address").text());""==n&&(a=!1),""==o&&(a=!1),""==i&&(a=!1);var s=t(".payment_method_check:checked"),r="";0==s.size()?(a=!1,t(".payment_method_error").show()):(r=s.attr("data-code"),t(".payment_method_error").hide());var c=t(".order_student_item");if(c.size()>0?t(".order_student_error").hide():(a=!1,t(".order_student_error").show()),a){var d=t.trim(t("#_token").val()),l={basket_number:this.basket_number,payment_method:r,_token:d};t(".order_submit").addClass("disabled"),e.post("/checkout/"+this.basket_number,l)}else{window.scrollTo(0,0);var h=t('<div class="site_msg_art msg_alert error show"><div class="msg_alert_content">'+t.tran("checkout.check_checkout_info","请完善您的订单信息")+"</div></div>").prependTo(".checkout_form");setTimeout(function(){h.remove()},2e3)}},i.post=function(t,e){var a=document.createElement("form");a.action=t,a.method="post",a.style.display="none";for(var n in e){var o=document.createElement("input");o.name=n,o.value=e[n],a.appendChild(o)}return document.body.appendChild(a),a.submit(),a},i.contactEvent=function(){t.validator.addMethod("phone",function(t,e){var a=/^[()+0-9_\-\s]*$/;return this.optional(e)||a.test(t)},t.tran("valid.valid_phone","请输入正确的电话号码"));var e=this;t(".contact_form").validate(this.contact_valid),t(".contact_form").on("click",function(a){var n=t(this),o=a||window.event,i=t(o.target||o.srcElement);i.hasClass("save_contact")&&(n.valid()&&e.doSaveContact(n,i),e.initLayerContact())}),t(".contact_form").on("keyup",function(a){var n=(t(this),a||window.event),o=t(n.target||n.srcElement);o.hasClass("form_control")&&e.initLayerContact()}),t(".hide_contact_layer").on("click",function(){t(".contact_layer").removeClass("show"),t(".contact_layer_box").removeClass("show"),t("html,body").css("overflow-y","auto")}),t(".edit_checkout_contact").on("click",function(a){var n=t.trim(t(".contact_fullname").text()),o=t.trim(t(".contact_phone").text()),i=t.trim(t(".family_address").text());$data={fullname:n,phone:o,family_address:i},e.initLayerContact($data)}),t(".hide_student_layer").on("click",function(){t(".student_layer_overlay").hide(),t(".student_layer").removeClass("show"),t(".student_layer_box").removeClass("show"),t("html,body").css("overflow-y","auto")}),t(".contact_student_form").validate(this.student_valid),t(".edit_student").on("click",function(a){var n=t(this),o=n.attr("data-id");t.postForm(n,"/api/account/student/load",{student_id:o},function(t){if("200"==t.code){var a={};a.student_id=o,a.fullname=t.data.fullname,a.sex=t.data.sex;try{var n=t.data.birthday,i=new Date(n),s=i.getFullYear(),r=i.getMonth()+1;r<10&&(r="0"+r);var c=i.getDate();c<10&&(c="0"+c),a.year=s,a.month=r,a.day=c}catch(t){}e.initLayerStudent(a)}})}),t(".add_student").on("click",function(){var t={sex:"1"},a=new Date("1991-01-01"),n=a.getFullYear(),o=a.getMonth()+1;o<10&&(o="0"+o);var i=a.getDate();i<10&&(i="0"+i),t.year=n,t.month=o,t.day=i,e.initLayerStudent(t)}),t(".contact_student_form").on("click",function(a){var n=t(this),o=a||window.event,i=t(o.target||o.srcElement);i.hasClass("save_student")&&(n.valid()&&e.doSaveStudent(n,i),e.initLayerStudent())})},i.contact_valid={rules:{fullname:{required:!0,maxlength:50},family_address:{required:!0,maxlength:255},phone:{required:!0,phone:!0,minlength:7,maxlength:32}}},i.student_valid={rules:{fullname:{required:!0,maxlength:50},year:{required:!0},month:{required:!0},day:{required:!0}}},i.doSaveContact=function(e,a,o){if(e.valid()){var i=e.serializeObject();t.postForm(a,"/api/account/contact/update",i,function(t){"200"==t.code?n.showMessage("success",t.message,function(){window.location.reload()}):n.showMessage("error",t.message)})}},i.doSaveStudent=function(e,a,o){if(e.valid()){var i=e.serializeObject(),s=i.year,r=i.month,c=i.day;i.birthday=s+"-"+r+"-"+c,t.postForm(a,"/api/account/student/save",i,function(t){"200"==t.code?n.showMessage("success",t.message,function(){window.location.reload()}):n.showMessage("error",t.message)})}},i.initLayerContact=function(e){t(".contact_layer").addClass("show"),t(".contact_layer_box").addClass("show"),t("html,body").css("overflow-y","hidden");var a=t(".contact_layer_box").find(".layerBox_wrapper");a.css({left:"50%","margin-left":"-"+a.width()/2+"px"});var o=n.getWinHeight();a.height()<o?a.css({top:"50%","margin-top":"-"+a.height()/2+"px"}):a.css({top:"10px","margin-top":"0px"}),e&&this.setContactForm(e)},i.initLayerStudent=function(e){t(".student_layer").addClass("show"),t(".student_layer_overlay").show(),t(".student_layer_box").addClass("show"),t("html,body").css("overflow-y","hidden");var a=t(".student_layer_box").find(".layerBox_wrapper");a.css({left:"50%","margin-left":"-"+a.width()/2+"px"});var o=n.getWinHeight();a.height()<o?a.css({top:"50%","margin-top":"-"+a.height()/2+"px"}):a.css({top:"10px","margin-top":"0px"}),e&&this.setStudentForm(e)},i.setContactForm=function(e){var a,n=t(".contact_form"),o=n.find("[name]");o.each(function(n){a=t(this).attr("name"),t(this).hasClass("check")&&(e[a]?t(this).prop("checked","checked"):t(this).removeAttr("checked")),t(this).val(e[a]?e[a]:"")})},i.setStudentForm=function(e){var a,n=t(".contact_student_form"),o=n.find("[name]");o.each(function(n){a=t(this).attr("name"),t(this).hasClass("check")&&(e[a]?t(this).prop("checked","checked"):t(this).removeAttr("checked")),t(this).is("select")&&t(this).find('option[value="'+e[a]+'"]').prop("selected","selected"),t(this).val(e[a]?e[a]:"")})},t(function(){i.init()})});