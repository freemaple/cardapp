require(["zepto","base","mylayer","validate","wangEditor","scrollComponent"],function(e,t,i,o,r,n){var a={init:function(){var t=this;e(".js-save-post").on("click",function(){e(".post-save-form").find(".btn-submit").click()});new FormValidator("post-save-form",t.postValid,function(o,r){var n=e(r.target);if(n.find(".errormsg").html(""),o.length>0)return t.showValidatorError(o,n),!1;var a=n.attr("data-action"),s=(n.serializeObject(),new FormData(n[0])),c=[];if(n.find(".img").each(function(){var t=e(this).attr("src"),i=e(this).attr("data-name");t&&c.push({src:t,name:i})}),c=JSON.stringify(c),s.append("imgs",c),0==c.length)return i.showTip("请选择图片",5e3,"error"),!1;var l=[];n.find(".card_id:checked").each(function(){var t=e(this).val();l.push(t)}),s.append("card_ids",JSON.stringify(l));i.showLoad(!0);return e.ajax({url:a,type:"POST",data:s,processData:!1,contentType:!1,success:function(t){"Success"==t.code?(window.post_save=!0,i.showTip(t.message,3e3,"success",function(){navigator.userAgent&&navigator.userAgent.indexOf("Html5Plus")>-1?window.isplusback=!0:window.location.href="/account/post"})):(i.hideLoad(),e.showRequestError(t))},error:function(t){i.hideLoad(),e.showRequestError(t)}}),!1});e(".post-save-form").on("submit",function(){return!1}),e(".upload-post-file").on("change",function(t){var o=e(this);try{var r=o[0].files;if(r&&r.length>0){if(!r[0].type||e.inArray(r[0].type,["image/png","image/gif","image/jpg","image/jpeg"])==-1)return i.showTip(tipMessage.upload_image_format_tip,5e3,"error"),!1;if(r[0].size){var n=r[0].size/1048576;if(n>3)return i.showTip(tipMessage.upload_maximum_tip,5e3,"error"),!1}}var a=r[0],s=new FileReader;s.readAsDataURL(a),s.onload=function(e){var t=this.result,i=o.closest(".post-image-item"),r=i.find(".img");r.attr("src",t)}}catch(e){}}),this.descriptionEditor("post-description"),require(["jquery","colpick"],function(t){t("#picker").colpick({onSubmit:function(i,o,r,n){var a="#"+o;e(".select_color_code").val(a),e(".background_color").css("background_color",a),t(n).colpickHide()},onChange:function(t,i,o,r,n){var a="#"+i;e(".select_color_code").val(a),e(".background_color").css("background_color",a)}})}),e(".background_color").on("click",function(){e("#picker").click()}),e(".post-music-edit").on("click",function(){var o=e("#edit-music-template").html(),r=e(".post_music").val();i.init({content:o,close:!1,class_name:"layer-edit-music",position:"top"}),t.pushMusicState(),e(".music-list-item").each(function(){var t=e(this).attr("data-id");t==r&&(e(".music-list-item").removeClass("selected"),e(this).addClass("selected"))})}),e(document).on("click",".select-music-item",function(){var t=e(this).closest(".music-list-item");e(".music-list-item").removeClass("selected"),t.addClass("selected")}),e(document).on("click",".save-music",function(){var t=e(".music-list-item.selected");if(0==t.size())return i.showTip("请选择音乐!",3e3,"error"),!1;var o=t.attr("data-id"),r=t.attr("data-name"),n=e(".layer-edit-music");i.hideLayer(n),e(".post_music").val(o),e(".post-music-edit").val(r)}),e(document).on("click",".js-play-music",function(){var i=e(this),o=e(this).attr("data-id"),r="music-audio-"+o,n=e(this).attr("data-music");e("#"+r).attr("src",n),i.attr("data-play")&&"1"==i.attr("data-play")?(t.stop(r),e(this).removeAttr("data-play"),i.removeClass("play")):(t.stopAll(),t.music(r),e(this).attr("data-play","1"),i.addClass("play"))}),e(".wangEditor-menu-container").size()>0&&(window.onscroll=function(){var t=e(window).scrollTop();e(".post-description-box").offset().top;t>100?e(".wangEditor-menu-container").addClass("fixed"):e(".wangEditor-menu-container").removeClass("fixed")}),e(document).on("click",".js-add-video-link",function(){var o=(e(this),e(".video_link").val()),r="<iframe height=320 width='100%' src='"+o+"' frameborder=0 'allowfullscreen'></iframe>";t.ceditor.command(null,"insertHtml",r);var n=e(".layer-videolink"),a=n.attr("data-id");i.closeLayer(a)}),e(document).on("click",".js-post-delete",function(){var t=e(this).attr("data-id");i.showConfirm("确认删除此文章？",function(){e.ajaxPost("/api/post/delete",{post_id:t},function(e){"Success"==e.code&&window.location.reload()})})}),e(document).on("click",".js-post-reprint-delete",function(){var t=e(this).attr("data-id");i.showConfirm("确认删除此转载文章？",function(){e.ajaxPost("/api/post/deleteReprint",{post_id:t},function(e){"Success"==e.code&&window.location.reload()})})}),e(window).on("popstate",function(t){var o=e(".layer-edit-music");o.size()>0&&i.hideLayer(o)})},pushMusicState:function(){if(history&&history.pushState){var t=window.location.search;t=e.changeURLArg(t,"link","music");var i=window.location.pathname+t+window.location.hash;history.pushState({title:document.title,url:i},document.title,i)}},stopAll:function(){e(".music-audio").each(function(){var t=e(this).closest(".js-play-music");t.removeAttr("data-play"),t.removeClass("play");var i=e(this).attr("id"),o=document.getElementById(i);o.currentTime=0,o.pause()})},stop:function(e){var t=document.getElementById(e);t.currentTime=0,t.pause()},music:function(e){var t=document.getElementById(e);null!=t&&(t.load(),t.play())},postValid:[{name:"name",rules:"required",message:{required:"请输入标题！"}}],showValidatorError:function(t,i){for(var o=0,r=t.length;o<r;o++){var n=e(t[o].element);0==n.next(".errormsg").size()&&n.after('<div class="errormsg"></div>'),n.next(".errormsg").html(t[o].message)}var a=i.offset().top;window.scrollTo(0,a)},descriptionEditor:function(t){if("undefined"==typeof r)return null;if(0==e("#"+t).size())return null;r.config.printLog=!1;var o=new r(t);return o.config.menus=["img","head","bold","fontSize","fontName","forecolor","bgcolor","italic","underline","strikeThrough","alignleft","aligncenter","alignright","undo","redo","table","list","emoticon","video"],o.config.lang=r.langs.en,o.config.colors={"#880000":"Dark Red","#800080":"Purple","#ff0000":"Red","#ff00ff":"Fresh pink","#000080":"Navy Blue","#0000ff":"Blue","#00ffff":"Lake Blue","#008080":"Blue-Green","#008000":"Green","#808000":"Olive","#00ff00":"Light Green","#ffcc00":"Orange","#808080":"Gray","#c0c0c0":"Silver","#000000":"Black","#ffffff":"White"},o.config.uploadImgShowBase64=!0,o.create(),e(".wangeditor-menu-img-picture").closest(".menu-item").off("click").on("click",function(){return e("#editor_upload_post").click(),!1}),e(".wangeditor-menu-img-play").closest(".menu-item").off("click").on("click",function(){var t=e("#video-link-template").html();return i.init({content:t,close:!1,class_name:"layer-videolink",position:"center"}),!1}),e("#editor_upload_post").on("change",function(t){var r=(e(this),t||window.event),n=e(r.target||r.srcElement);try{var a=n[0].files;if(a&&a.length>0){if(!a[0].type||e.inArray(a[0].type,["image/png","image/jpg","image/gif","image/jpeg"])==-1)return i.showTip("请上传图片格式",5e3,"error"),!1;if(a[0].size){var s=a[0].size/1048576;if(s>5)return i.showTip("图片不能超过5M",5e3,"error"),!1}}var c=a[0],l=new FileReader;l.readAsDataURL(c),l.onload=function(e){var t=this.result;o.command(null,"insertHtml",'<img src="'+t+'" style="max-width:100%;"/>')}}catch(e){}}),this.ceditor=o,o},editorupload:function(t){var o={success:function(e){if("200"==e.code){var o=e.info.img_src?e.info.img_src:"";t.command(null,"insertHtml",'<img src="'+o+'" style="max-width:100%;"/>')}else e.result&&i.showMessage("error",e.result)},error:function(){i.showMessage("error","Sorry,please try it again!")}},r=document.getElementById("editor_post_form");e("#upload_file_name").val("editor_upload_file"),new asyncForm(r,o).submit(function(e,t){o.success(e)})}};"function"==typeof a.init&&e(function(){a.init()})});