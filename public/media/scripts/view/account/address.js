require(["zepto","base","mylayer","validate"],function(e,t,i,a){var r={init:function(){var t=this,a=e.getQueryVariable("is_redirect_back");t.is_redirect_back=a,e(document).on("click",".js-add-address",function(){t.loadAddressForm({id:"",is_default:"1"},function(t){e(".set-default-box").hide()})}),e(document).on("click",".js-select-address",function(){i.hideTip();var t=e(this).attr("data-id"),r=e(this).closest(".address-list-item");address_value=r.find(".address-value").html(),i.showLoad(),e.ajaxPost("/api/address/setdefault",{id:t},function(t){i.hideLoad(),"Success"==t.code?(r.addClass("selected").siblings(".address-list-item").removeClass("selected"),i.showTip(t.message,3e3,"success"),"1"==a&&(window.location.href=e("#backredirecturl").val())):e.showRequestError(t)},function(t){e.showRequestError(t),i.hideLoad()})}),e(document).on("click",".js-edit-address",function(){var i=e(this),a=i.attr("data-id"),r={id:a,fullname:i.attr("data-fullname"),phone:i.attr("data-phone"),province_id:i.attr("data-province"),city_id:i.attr("data-city"),district_id:i.attr("data-district"),town_id:i.attr("data-town"),village_id:i.attr("data-village"),address:i.attr("data-address"),zip:i.attr("data-zip"),is_default:i.attr("data-default")};t.loadAddressForm(r,function(e){e.find(".set-default-box").hide()})}),e(document).on("click",".js-remove-address",function(){var t=e(this);i.showConfirm("确认删除地址?",function(){var i=t.attr("data-id");e.ajaxPost("/api/address/delete",{id:i},function(t){"Success"==t.code?window.location.reload():e.showRequestError(t)})},function(t){e.showRequestError(t)})})},loadAddressForm:function(t,a){var r=this,s=e("#address-form-template").html();i.init({content:s,close:!1,class_name:"layer-address-save-form layer-top left-to-top",position:"top",callback:function(){r.initAddressFrom(t,a)}}),r.addressFormEvent(),t.id?this.initP(t):(e(".province_select").val(""),e(".city_select").html(""),e(".county_select").html(""),e(".town_select").html(""),e(".village_select").html("")),window.scrollTo(0,0)},initAddressFrom:function(t,i){var a=this,r=e(".layer-address-save-form").find(".shipping-address-form");a.setFormData(r,t);var r=e(".layer-address-save-form").find(".shipping-address-form");"function"==typeof i&&i(r),require(["jquery","distpicker"],function(e){e("#distpicker1").distpicker("destroy"),e("#distpicker1").distpicker(t)})},initP:function(t){e.ajaxGet("/api/position/getAddress",t,function(i){if("Success"==i.code){var a=i.data,r='<option value="">请选择</option>';e.each(a.citys,function(e,t){r+='<option value="'+t.city_id+'">'+t.city_name+"</option>"}),e(".city_select").html(r).val(t.city_id);var s='<option value="">请选择</option>';e.each(a.countys,function(e,t){s+='<option value="'+t.county_id+'">'+t.county_name+"</option>"}),e(".county_select").html(s).val(t.district_id);var o='<option value="">请选择</option>';e.each(a.towns,function(e,t){o+='<option value="'+t.town_id+'">'+t.town_name+"</option>"}),e(".town_select").html(o).val(t.town_id);var d='<option value="">请选择</option>';e.each(a.villages,function(e,t){d+='<option value="'+t.village_id+'">'+t.village_name+"</option>"}),e(".village_select").html(d).val(t.village_id)}})},addressFormEvent:function(){var t=this;new FormValidator("shipping-address-form",t.addressFormRule,function(a,r){var s=e(r.target);if(s.find(".errormsg").html(""),a.length>0)return t.showValidatorError(a,s),!1;var o=(s.attr("data-action"),s.serializeObject()),d=(i.showLoad(!0),s.find("[name=is_default]").prop("checked")),n=d?"1":"0";o.is_default=n,i.showLoad(!0),o.id&&o.id>0?e.ajaxPost("/api/address/edit",o,function(a){i.hideLoad(),"Success"==a.code?"1"==t.is_redirect_back?window.location.href=e("#backredirecturl").val():window.location.href=window.location.href:e.showRequestError(a)},function(t){e.showRequestError(t)}):e.ajaxPost("/api/address/add",o,function(a){i.hideLoad(),"Success"==a.code?"1"==t.is_redirect_back?window.location.href=e("#backredirecturl").val():window.location.href=window.location.href:e.showRequestError(a)})});e(".shipping-address-form").on("submit",function(){return!1})},addressFormRule:[{name:"fullname",rules:"required|max_length[50]",message:{required:"请输入姓名！"}},{name:"phone",rules:"required|numeric|max_length[50]",message:{required:"请输入手机号码！",numeric:"请输入手机号码！"}},{name:"province",rules:"required",message:{required:"请选择省份！"}},{name:"city",rules:"required",message:{required:"请选择城市！"}},{name:"district",rules:"required",message:{required:"请选择区！"}},{name:"address",rules:"required",message:{required:"请输入地址！"}},{name:"zip",rules:"required",message:{required:"请输入邮编！"}}],showValidatorError:function(t,i){for(var a=0,r=t.length;a<r;a++){var s=e(t[a].element);0==s.next(".errormsg").size()&&s.after('<div class="errormsg"></div>'),s.next(".errormsg").html(t[a].message)}var o=i.offset().top;window.scrollTo(0,o)},setFormData:function(t,i){var a,r=t.find("[name]");r.each(function(t){a=e(this).attr("name"),e(this).hasClass("check")&&(i[a]?e(this).prop("checked","checked"):e(this).removeAttr("checked")),e(this).val(i[a]?i[a]:"")})}};"function"==typeof r.init&&e(function(){r.init()})});