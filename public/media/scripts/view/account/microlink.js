require(["zepto","base","mylayer","validate"],function(o,i,e,r){var n={init:function(){var i=this;o(document).on("click",".js-add-microlink",function(){i.loadMicrolinkForm(function(){var e=o(".layer-microlink-save-form"),r=e.find(".microlink-form");i.setFormData(r,{id:""}),r.find(".current-icon-box").html("")})}),o(document).on("click",".js-edit-microlink",function(){var e=o(this),r=e.attr("data-id");o.ajaxGet("/api/microlink/load",{id:r},function(e){if(e.data){var r=e.data;i.loadMicrolinkForm(function(){var e=o(".layer-microlink-save-form"),n=e.find(".microlink-form");i.setFormData(n,r),n.find(".current-icon-box").html(r.svg),n.find(".current-icon-box").find("svg").attr("fill","#ffffff")})}})}),o(document).on("click",".js-remove-microlink",function(){var i=o(this);e.showConfirm("是否删除此微链接?",function(){var e=i.attr("data-id");o.ajaxPost("/api/microlink/delete",{id:e},function(i){"Success"==i.code?window.location.reload():o.showRequestError(i)})},function(i){o.showRequestError(i)})}),o(document).on("click",".js-show-select-icon",function(){if(o(".layer-select-icon").size()>0){var i=o(".layer-select-icon");e.showLayer(i),"function"==typeof callback&&callback()}else{var r=o("#icon-select-template").html();e.init({content:r,close:!1,class_name:"layer-select-icon layer-top left-to-top no-remove",position:"top"})}}),o(document).on("click",".js-select-icon",function(){o(".icon-item").removeClass("select"),o(this).addClass("select")}),o(document).on("click",".js-confirm-icon",function(){var i=o(".js-select-icon.select"),r=i.attr("data-id"),n=i.find(".icon-item-box").html();o(".current-icon-box").html(n),o(".microlink-form").find(".icon_id").val(r),o(".microlink-form").find("svg").attr("fill","#ffffff");var t=o(".layer-select-icon");e.hideLayer(t)})},microlinkFormEvent:function(){var i=this;new FormValidator("microlink-form",i.microlinkFormRule,function(r,n){var t=o(n.target);if(t.find(".errormsg").html(""),r.length>0)return i.showValidatorError(r,t),!1;var c=t.serializeObject();e.showLoad(!0);c.id&&c.id>0?o.ajaxPost("/api/microlink/edit",c,function(i){e.hideLoad(),"Success"==i.code?window.location.reload():o.showRequestError(i)},function(i){o.showRequestError(i)}):o.ajaxPost("/api/microlink/add",c,function(i){e.hideLoad(),"Success"==i.code?window.location.href=window.location.href:o.showRequestError(i)})});o(".microlink-form").on("submit",function(){return!1})},showValidatorError:function(i,e){for(var r=0,n=i.length;r<n;r++){var t=o(i[r].element);0==t.next(".errormsg").size()&&t.after('<div class="errormsg"></div>'),t.next(".errormsg").html(i[r].message)}var c=e.offset().top;window.scrollTo(0,c)},loadMicrolinkForm:function(i){var r=this;if(o(".layer-microlink-save-form").size()>0){var n=o(".layer-microlink-save-form");e.showLayer(n),"function"==typeof i&&i()}else{var t=o("#microlink-form-template").html();e.init({content:t,close:!1,class_name:"layer-microlink-save-form layer-top left-to-top no-remove",position:"top",callback:function(){r.microlinkFormEvent(),"function"==typeof i&&i()}})}window.scrollTo(0,0)},microlinkFormRule:[{name:"icon_id",rules:"required",message:{required:"请选择图标"}},{name:"name",rules:"required",message:{required:"请输入名称"}},{name:"link",rules:"required|valid_url",message:{required:"请输入链接",valid_url:"请输入有效的链接"}}],setFormData:function(i,e){var r,n=i.find(".form-control");n.each(function(i){r=o(this).attr("name"),o(this).hasClass("check")&&(e[r]?o(this).prop("checked","checked"):o(this).removeAttr("checked")),o(this).val(e[r]?e[r]:"")})}};"function"==typeof n.init&&o(function(){n.init()})});