require(["zepto","base","mylayer","loginReg","validate"],function(e,a,t,i,o){var n={};n.init=function(){var a=this;this.order_id=e("#order_id").val(),this.order_no=e("#order_id").attr("data-order-no"),this.autoPay(),e(".payment-item").on("click",function(){e(this).addClass("selected").siblings(".payment-item").removeClass("selected")}),e(".order-pay-submit").on("click",function(){var i=e(".payment-item.selected").attr("data-code");t.showLoad(!0),"weixin"==i&&a.wxHandle()})},n.autoPay=function(){var a=this,i=e("#is_auto_pay").val(),o=e(".payment-item.selected").attr("data-code"),n=e.getCookie("is_auto_pay");if(i&&o&&("1"==n||1==window.isAPP)){e.setCookie("is_auto_pay","0");document.referrer;t.showLoad(!0),"weixin"==o&&a.wxHandle();var r=window.location.href;r=e.delParam(r,"is_auto_pay"),history.pushState({title:document.title,url:r},document.title,r)}},n.wxHandle=function(){var a=this,i=this.order_id;e.ajaxPost("/api/order/pay?order_id="+i,{payment:"weixin"},function(i){"Success"==i.code?(a.checkPay(),i.data.is_weixin?a.wxPay(i):i.data.mweb_url&&(window.location.href=i.data.mweb_url)):(t.hideLoad(),e.showRequestError(i))},function(a){t.hideLoad(),e.showRequestError(a)})},n.checkPay=function(){var e=this,a=0;e.payInterval=setInterval(function(){a++,a>100?window.clearInterval(e.payInterval):e.checkOrderPay(e.order_id)},3e3)},n.wxPay=function(e){var a=this,t=e.data,i=this.order_id;wx.config({appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.paySign,jsApiList:["chooseWXPay"]});var o={appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,package:t.package,signType:t.signType,paySign:t.paySign,success:function(){a.checkOrderPay(i)},cancel:function(e){window.location.reload()}};wx.ready(function(){wx.chooseWXPay(o)})},n.checkOrderPay=function(a){var t=this;e.ajaxPost("/api/order/checkOrderPay",{order_id:a},function(e){"Success"==e.code&&("undefined"!=typeof t.payInterval&&window.clearInterval(t.payInterval),window.location.replace("/account/order/pay/success/"+t.order_no))})},"function"==typeof n.init&&e(function(){n.init()})});