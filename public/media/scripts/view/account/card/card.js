require(["zepto","base","mylayer","validate"],function(t,e,a,i){var r={init:function(){var e=this;t(".js-save-card").on("click",function(){t(".card-save-form").find(".btn-submit").click()});new FormValidator("card-save-form",e.cardValid,function(i,r){var s=t(r.target);if(s.find(".errormsg").html(""),i.length>0)return e.showValidatorError(i,s),!1;var o=s.attr("data-action"),c=s.serializeObject(),n=t(".qr-image").attr("src");n&&(c.weixin_qr=n);a.showLoad(!0);return t.ajaxPost(o,c,function(e){a.hideLoad(),"Success"==e.code?(a.showTip(e.message,3e3,"success"),e.data.link&&(window.location.href=e.data.link)):t.showRequestError(e)},function(e){a.hideLoad(),t.showRequestError(e)}),!1});t(".card-save-form").on("submit",function(){return!1}),t(".js-change-qt").on("click",function(){t(".qr-upload-file").click()}),t(".qr-upload-form").on("change",function(e){var i=(t(this),e||window.event),r=t(i.target||i.srcElement);if(r.hasClass("qr-upload-file"))try{var s=r[0].files;if(s&&s.length>0){if(!s[0].type||t.inArray(s[0].type,["image/png","image/gif","image/jpg","image/gif","image/jpeg"])==-1)return a.showTip("请上传图片格式",5e3,"error"),!1;if(s[0].size){var o=s[0].size/1048576;if(o>5)return a.showTip("图片不能超过5M",5e3,"error"),!1}}var c=s[0],n=new FileReader;n.readAsDataURL(c),n.onload=function(e){var a=this.result;t(".qr-image");t(".qr-image").attr("src",a)}}catch(t){}}),require(["jquery","distpicker"],function(t){var e=t("#distpicker1");e.distpicker({province:e.attr("data-province"),city:e.attr("data-city"),district:e.attr("data-district")})}),"undefined"!=typeof BMap&&(t(".js-show-map").on("click",function(){if(t(".layer-map").size()>0){var i=t(".layer-map");a.showLayer(i)}else{var r=t("#map-template").html();a.init({content:r,close:!1,class_name:"layer-map no-remove",position:"top",success:function(){s.init()}})}var o=e.getAddress();s.init(o)}),s.autoLocation(function(e){t(".address_street").val(e.address_street),require(["jquery","distpicker"],function(t){t("#distpicker1").distpicker("destroy"),t("#distpicker1").distpicker(e)})})),t(document).on("click",".js-show-select-background",function(){if(t(".layer-select-background").size()>0){var e=t(".layer-select-background");a.showLayer(e),"function"==typeof callback&&callback()}else{var i=t("#background-select-template").html();a.init({content:i,close:!1,class_name:"layer-select-background layer-top left-to-top",position:"top"})}}),t(document).on("click",".js-background-item",function(){var e=t(this).attr("data-src"),i=(t(this).attr("data-id"),t(this).attr("data-image")),r=t(".layer-select-background");a.hideLayer(r),t(".theme-bg").css("background-image","url("+e+")"),t(".background_image").val(i),t(".card-background_img").attr("src",e)}),t(".card-custom-save").on("click",function(){var e=t(".card-custom-form"),a=e.serializeObject();t.ajaxPost("/api/card/custom/save",a,function(t){"Success"==t.code&&window.location.reload()})}),t(".card-music-edit").on("click",function(){var i=t("#edit-music-template").html(),r=t(".card_music").val();a.init({content:i,close:!1,class_name:"layer-edit-music",position:"top"}),e.pushMusicState(),t(".music-list-item").each(function(){var e=t(this).attr("data-id");e==r&&(t(".music-list-item").removeClass("selected"),t(this).addClass("selected"))})}),t(document).on("click",".select-music-item",function(){var e=t(this).closest(".music-list-item");t(".music-list-item").removeClass("selected"),e.addClass("selected")}),t(document).on("click",".save-music",function(){var e=t(".music-list-item.selected");if(0==e.size())return a.showTip("请选择音乐!",3e3,"error"),!1;var i=e.attr("data-id"),r=e.attr("data-name"),s=t(".layer-edit-music");a.hideLayer(s),t(".card_music").val(i),t(".card-music-edit").val(r)}),t(document).on("click",".js-play-music",function(){var a=t(this),i=t(this).attr("data-id"),r="music-audio-"+i,s=(document.getElementById(r),t(this).attr("data-music"));t("#"+r).attr("src",s),a.attr("data-play")&&"1"==a.attr("data-play")?(e.stop(r),t(this).removeAttr("data-play"),a.removeClass("play")):(e.stopAll(),e.music(r),t(this).attr("data-play","1"),a.addClass("play"))}),t(window).on("popstate",function(e){var i=t(".layer-edit-music");i.size()>0&&a.hideLayer(i)})},pushMusicState:function(){if(history&&history.pushState){var e=window.location.search;e=t.changeURLArg(e,"link","music");var a=window.location.pathname+e+window.location.hash;history.pushState({title:document.title,url:a},document.title,a)}},cardValid:[{name:"name",rules:"required",message:{required:"请输入名片名称！"}}],showValidatorError:function(e,a){for(var i=0,r=e.length;i<r;i++){var s=t(e[i].element);0==s.next(".errormsg").size()&&s.after('<div class="errormsg"></div>'),s.next(".errormsg").html(e[i].message)}var o=a.offset().top;window.scrollTo(0,o)},getAddress:function(){var e=t(".province").val(),a=t(".city").val(),i=t(".district").val(),r=t(".address_street").val(),s=e+a+i+r;return s},stop:function(t){var e=document.getElementById(t);e.currentTime=0,e.pause()},stopAll:function(){t(".music-audio").each(function(){var e=t(this).closest(".js-play-music");e.removeAttr("data-play"),e.removeClass("play");var a=t(this).attr("id"),i=document.getElementById(a);i.currentTime=0,i.pause()})},music:function(t){var e=document.getElementById(t);null!=e&&(e.load(),e.play())}},s={init:function(t){var e=new BMap.Map("allmap"),a=new BMap.Geocoder;t?a.getPoint(t,function(t){t&&(e.centerAndZoom(t,16),e.addOverlay(new BMap.Marker(t)))}):this.autoLocation(),e.addControl(new BMap.MapTypeControl({mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]})),e.enableScrollWheelZoom(!0),e.addEventListener("click",function(t){this.setLocation(t.point)})},autoLocation:function(t){var e=new BMap.Geolocation;e.getCurrentPosition(function(t){this.getStatus()==BMAP_STATUS_SUCCESS})},setLocation:function(t,e){var a=new BMap.Geocoder;a.getLocation(t,function(t){var a=t.addressComponents,i=a.province+a.city+a.district+a.street+a.streetNumber,r=a.province,s=a.city,o=a.district,c=a.street+a.streetNumber,n={address:i,province:r,city:s,district:o,address_street:c};e(n)})}};t(function(){r.init()})});