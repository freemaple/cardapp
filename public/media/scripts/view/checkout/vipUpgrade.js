require(["zepto","base","mylayer","validate","scrollComponent"],function(e,t,i,r,a){function n(e){var t=o();return t[e]}function o(){for(var e=(location.hash||"").replace(/^\#/,"").split("&"),t={},i=0;i<e.length;i++){var r=e[i].split("=");2==r.length&&(t[r[0]]=r[1])}return t}var s={init:function(){var t=this,r=e("#order_no").val();r||(r=n("order_no")),r&&t.checkOrderPay(r);var a=e("#address_id").val(),o=e("#product_id").attr("gift-id"),s=e("#upgrade_type").val(),c=e("#uid").val(),o=e("#product_id").attr("gift-id"),l=e("#use_integral").val(),u=e("#use_reward").val(),p=e("#product_sku_id").val();if(e(".js-vip-pay").on("click",function(){var r={};if(1==s){if(!a)return i.showTip("请先添加地址",3e3,"error"),!1;var n=e(".agreement_checkbox");if(!n.is(":checked"))return i.showTip("请先同意店铺合同协议书！",3e3,"error"),!1;r.address_id=a}else if(2==s){var d=e(".shipping-address-form").serializeObject();d.province=e(".province_select option").not(function(){return!this.selected}).text(),d.city=e(".city_select option").not(function(){return!this.selected}).text(),d.district=e(".county_select option").not(function(){return!this.selected}).text(),d.town=e(".town_select option").not(function(){return!this.selected}).text(),d.village=e(".village_select option").not(function(){return!this.selected}).text(),r.address_data=d}r.gift_id=o,r.product_sku_id=p,r.upgrade_type=s,r.uid=c,r.use_integral=l,r.use_reward=u;i.showLoad(!0,!0);e.ajaxPost("/api/order/vipUpgrade",r,function(e){if("Success"==e.code){var r=e.data.order_no;t.checkPay(r),!window.isAPP&&r&&t.pushState(r),e.data.is_weixin?t.wxPay(e):"undefined"!=typeof e.data.mweb_url&&(e.data.mweb_url.indexOf("/account")!=-1?(window.isplusbuy=!0,window.location.replace(e.data.mweb_url)):window.location.href=e.data.mweb_url)}else e.message&&(i.hideLoad(),i.showTip(e.message,3e3,"error"))})}),e(".use_integral_checked").on("click",function(){var t=window.location.href,r=!!e(this).is(":checked");t=r?e.changeURLArg(t,"use_integral","1"):e.delParam(t,"use_integral"),i.showLoad();var a=JSON.stringify(e(".shipping-address-form").serializeObject());sessionStorage.setItem("r_address_data",a),window.location.href=t}),e(".use_reward_checked").on("click",function(){var t=window.location.href,r=!!e(this).is(":checked");t=r?e.changeURLArg(t,"use_reward","1"):e.delParam(t,"use_reward"),i.showLoad();var a=JSON.stringify(e(".shipping-address-form").serializeObject());sessionStorage.setItem("r_address_data",a),window.location.href=t}),e(document).on("click",".js-show-store-agreement",function(){var r=e("#store-agreement-template").html();i.init({content:r,close:!1,class_name:"layer-store-agreement",position:"top"}),t.pushAgreementState()}),e(window).on("popstate",function(t){var r=e(".layer-store-agreement");i.hideLayer(r)}),e(".shipping-address-form").size()>0&&2==s){var h=window.sessionStorage.getItem("r_address_data");h=JSON.parse(h),this.loadForm(e(".shipping-address-form"),h),require(["jquery","distpicker"],function(e){e("#distpicker1").distpicker("destroy"),e("#distpicker1").distpicker(h),t.initP(h)})}1==s&&d.init()},initP:function(t){e.ajaxGet("/api/position/getAddress",t,function(i){if("Success"==i.code){var r=i.data,a='<option value="">请选择</option>';e.each(r.citys,function(e,t){a+='<option value="'+t.city_id+'">'+t.city_name+"</option>"}),e(".city_select").html(a).val(t.city_id);var n='<option value="">请选择</option>';e.each(r.countys,function(e,t){n+='<option value="'+t.county_id+'">'+t.county_name+"</option>"}),e(".county_select").html(n).val(t.district_id);var o='<option value="">请选择</option>';e.each(r.towns,function(e,t){o+='<option value="'+t.town_id+'">'+t.town_name+"</option>"}),e(".town_select").html(o).val(t.town_id);var s='<option value="">请选择</option>';e.each(r.villages,function(e,t){s+='<option value="'+t.village_id+'">'+t.village_name+"</option>"}),e(".village_select").html(s).val(t.village_id)}})},loadForm:function(t,i){var r=t.find(".form-control");r.each(function(t,r){var a=e(this).attr("name");i[a]&&e(this).val(i[a]),e(this).is("select")&&e(this).find('option[value="'+i[a]+'"]').prop("selected","selected")})},checkPay:function(e){var t=this,i=1;t.payInterval=setInterval(function(){i++,i>100?window.clearInterval(t.payInterval):t.checkOrderPay(e)},3e3)},pushAgreementState:function(){if(history&&history.pushState){var t=window.location.search;t=e.changeURLArg(t,"link","agreement");var i=window.location.pathname+t+window.location.hash;history.pushState({title:document.title,url:i},document.title,i)}},pushState:function(t){if(location.hash="order_no="+t,!is_weixin&&history&&history.pushState){var i=window.location.search;"undefined"!=typeof t&&t&&(i=e.changeURLArg(i,"order_no",t));var r=window.location.pathname+i+window.location.hash;history.pushState({title:document.title,url:r},document.title,r)}},wxPay1:function(e){var t=this,i=e.data,r=e.data.order_no;WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:i.appId,timeStamp:i.timestamp,nonceStr:i.nonceStr,package:i.package,signType:i.signType,paySign:i.paySign},function(e){t.checkOrderPay(r),"get_brand_wcpay_request:ok"==e.err_msg?window.location.reload():window.location.reload()})},wxPay:function(e){var t=this,i=e.data,r=e.data.order_no;wx.config({appId:i.appId,timestamp:i.timestamp,nonceStr:i.nonceStr,signature:i.paySign,jsApiList:["chooseWXPay"]});var a={appId:i.appId,timestamp:i.timestamp,nonceStr:i.nonceStr,package:i.package,signType:i.signType,paySign:i.paySign,success:function(){t.checkOrderPay(r)},cancel:function(e){window.location.reload()}};wx.ready(function(){wx.chooseWXPay(a)})},checkOrderPay:function(t){var i=this;e.ajaxPost("/api/order/checkVipOrderPay",{order_no:t},function(e){"Success"==e.code&&("undefined"!=typeof i.payInterval&&window.clearInterval(i.payInterval),window.location.href="/checkout/vip/success/"+t)})}},d={init:function(){var t=this;require(["jquery","distpicker"],function(e){e("#distpicker1").distpicker("destroy")});new FormValidator("shipping-address-form",t.addressFormRule,function(r,a){var n=e(a.target);if(n.find(".errormsg").html(""),r.length>0)return t.showValidatorError(r,n),!1;var o=(n.attr("data-action"),n.serializeObject()),s=(i.showLoad(!0),n.find("[name=is_default]").prop("checked")),d=s?"1":"0";o.is_default=d,i.showLoad(!0),e.ajaxPost("/api/address/add",o,function(t){i.hideLoad(),"Success"==t.code?window.location.href=window.location.href:e.showRequestError(t)})});e(".shipping-address-form").on("submit",function(){return!1})},addressFormRule:[{name:"fullname",rules:"required|is_letter|max_length[50]",message:{required:"请输入姓名！"}},{name:"phone",rules:"required|numeric|max_length[50]",message:{required:"请输入手机号码！",numeric:"请输入手机号码！"}},{name:"province",rules:"required",message:{required:"请选择省份！"}},{name:"city",rules:"required",message:{required:"请选择城市！"}},{name:"district",rules:"required",message:{required:"请选择区！"}},{name:"address",rules:"required",message:{required:"请输入地址！"}},{name:"zip",rules:"required",message:{required:"请输入邮编！"}}],showValidatorError:function(t,i){for(var r=0,a=t.length;r<a;r++){var n=e(t[r].element);0==n.next(".errormsg").size()&&n.after('<div class="errormsg"></div>'),n.next(".errormsg").html(t[r].message)}var o=i.offset().top;window.scrollTo(0,o)}};"function"==typeof s.init&&e(function(){s.init()})});