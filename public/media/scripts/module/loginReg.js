define(["zepto","base","mylayer","validate"],function(e,r,i,n){var o={};return o.init=function(){this.is_redirect=!0,this.is_redirect_default=!1,this.initEvent()},o.initEvent=function(){var r=this;e(".js-show-entry-login").on("click",function(){var r=e(".js-entry-box");r.find(".login-panel").show().siblings(".entry-panel").hide()}),e(".js-show-entry-sign").on("click",function(){var r=e(".js-entry-box");r.find(".reg-panel").show().siblings(".entry-panel").hide()}),e(".js-show-entry-forget").on("click",function(){var r=e(".js-entry-box");r.find(".forget-panel").show().siblings(".entry-panel").hide()});new FormValidator("login-form",[{name:"phone",rules:"required",message:{required:"请输入手机号码！"}},{name:"password",rules:"required",message:{required:"请输入密码"}}],function(n,o){var s=e(o.target);if(s.find(".errormsg").html(""),n.length>0)return r.showValidatorError(n,s),!1;var t=s.attr("data-action"),a=s.serializeObject();a.password=e.password(a.password);i.showLoad(!0);e.ajaxPost(t,a,function(e){i.hideLoad(),"Success"==e.code?r.loginHandle():""!=e.message&&i.showTip(e.message,"3000","error")},function(e){i.showTip(r.tipMessage.request_error_tip,"3000","error")})});e(".login-form").on("submit",function(){return!1});new FormValidator("reg-form",[{name:"phone",rules:"required|numeric|max_length[50]",message:{required:"请输入手机号码！",numeric:"请输入手机号码！"}},{name:"fullname",rules:"required|max_length[50]",message:{required:"请输入姓名！"}},{name:"password",rules:"required|min_length[6]|max_length[50]",message:{required:"请输入登录密码！",min_length:"登录密码至少6位字符"}},{name:"t_password",rules:"required|min_length[6]|max_length[50]",message:{required:"请输入交易密码！",min_length:"交易密码至少6位字符"}},{name:"verification_code",rules:"required",message:{required:"请输入验证码！"}}],function(n,o){var s=e(o.target);if(s.find(".errormsg").html("").hide(),n.length>0)return r.showValidatorError(n,s),!1;var t=s.attr("data-action"),a=s.serializeObject();a.password=e.password(a.password);i.showLoad(!0);e.ajaxPost(t,a,function(n){if(i.hideLoad(),"Success"==n.code){var o=e("#register_redirect_link").val();window.location.href=o}else""!=n.message?i.showTip(n.message,"3000","error"):i.showTip(r.tipMessage.request_error_tip,"3000","error")},function(e){i.hideLoad(),i.showTip(r.tipMessage.request_error_tip,"3000","error")})});e(".reg-form").on("submit",function(){return!1});new FormValidator("forget-form",[{name:"phone",rules:"required|numeric|max_length[50]",message:{required:"请输入手机号码！",numeric:"请输入手机号码！"}},{name:"code",rules:"required",message:{required:"请输入验证码！"}},{name:"new_password",rules:"required",rules:"required|min_length[6]|max_length[50]",message:{required:"请输入新登录密码！",min_length:"新登录密码至少6位字符"}},{name:"new_password_confirmation",rules:"required|matches[new_password]",message:{required:"请输入确认密码！",matches:"确认密码和密码不一致"}}],function(n,o){var s=e(o.target);if(s.find(".errormsg").html("").hide(),n.length>0)return r.showValidatorError(n,s),!1;var t=s.attr("data-action"),a=s.serializeObject();i.showLoad(!0);e.ajaxPost(t,a,function(n){if(i.hideLoad(),"Success"==n.code){i.showTip(n.message,"3000","success");var o=e(".js-entry-box");o.find(".login-panel").show().siblings(".entry-panel").hide()}else""!=n.message?i.showTip(n.message,"3000","error"):i.showTip(r.tipMessage.request_error_tip,"3000","error")},function(e){return i.hideLoad(),e.errors?(r.showRequestError(e.errors,s),!1):void(""!=e.message?i.showTip(e.message,"3000","error"):i.showTip(r.tipMessage.request_error_tip,"3000","error"))})});e(".js-send-phonecode").on("click",function(){var n=e(this);if(n.hasClass("disabled"))return!1;if(n.hasClass("is_send"))return!1;var o=n.closest("form"),s=o.find(".phone_input"),t=e.trim(s.val());if(""==t)return i.showTip("请先输入手机号码","3000","error"),!1;n.addClass("disabled"),o.find(".code_send_tip_info").hide();var a=e(this).attr("data-type");e.ajaxPost("/api/auth/phone/code",{phone:t,type:a},function(e){"Success"==e.code?(o.find(".verificate_code_time").text("60"),o.find(".code_send_tip_info").show(),o.find(".code_send_tip").html(e.message),r.VerificateCodeInterval(n,o)):""!=e.message?(n.removeClass("disabled"),i.showTip(e.message,"3000","error")):n.removeClass("disabled")})}),e(".forget-form").on("submit",function(){return!1})},o.VerificateCodeInterval=function(e,r){var i=60,n=setInterval(function(){i>0&&(i-=1,r.find(".verificate_code_time").text(i)),i<=0&&(clearInterval(n),e.removeClass("disabled"),r.find(".code_send_tip_info").hide())},1e3)},o.loginRedirect=function(r){var i="/account",n=window.location.hostname;this.is_redirect_default||(r.indexOf(n)==-1&&(r=i),r&&r!=window.location.href&&r!=window.location.origin||(r=i)),previous_link||(previous_link=i);var o=r;o.indexOf("rid=")!=-1&&(o=e.delParam(o,"rid")),window.location.href=o},o.loginHandle=function(r){var i=this;if(e("#is_login_flag").val("1"),this.hideLogin(),i.is_redirect){var n=e("#previous_link").val();i.loginRedirect(n)}},o.showRequestError=function(r,i){e.each(r,function(e,r){var n=i.find("[name="+e+"]"),o=n.parent();0==o.find(".errormsg").size()&&o.append('<div class="errormsg"></div>'),o.find(".errormsg").html(r).show()});var n=i.offset().top;window.scrollTo(0,n)},o.showValidatorError=function(r,i){for(var n=0,o=r.length;n<o;n++){var s=e(r[n].element),t=s.parent();0==t.find(".errormsg").size()&&t.append('<div class="errormsg"></div>'),t.find(".errormsg").html(r[n].message).show()}var a=i.offset().top;window.scrollTo(0,a)},o.initSuccess=function(e){this.fevent=e},o.showLoginAction=function(r,i){"undefined"!=typeof i&&(this.is_redirect=i);var n=e("#is_login_flag").val();this.is_redirect&&"1"==n?window.location.href="/auth/login":(this.showLogin(),"undefined"!=typeof r&&this.initSuccess(function(){"function"==typeof r&&r()}))},o.showLogin=function(r,n){var o=this;if(!o.loginContent){var s=e("#js-quick-login-box");o.loginContent=s.html(),s.remove()}if(0==e(".quick-login-layer").size())var t=o.loginContent,a=i.init({content:t,close:!0,position:"top",callback:r,class_name:"layer-top left-to-top quick-login-layer no-remove",callback:function(){if(o.init(),"function"==typeof r&&r(),n){var i=e(".js-entry-box");i.find("."+n).show().siblings(".entry-panel").hide()}}});else{var a=e(".quick-login-layer");i.showLayer(a);var d=e(".js-entry-box");d.find("."+n).show().siblings(".entry-panel").hide()}},o.hideLogin=function(){var r=e(".quick-login-layer");i.hideLayer(r)},o.tipMessage={request_error_tip:"网络错误！"},o});