require(["zepto","base","mylayer","validate","scrollComponent"],function(e,t,o,n,a){function r(e){var t=i();return t[e]}function i(){for(var e=(location.hash||"").replace(/^\#/,"").split("&"),t={},o=0;o<e.length;o++){var n=e[o].split("=");2==n.length&&(t[n[0]]=n[1])}return t}var c={init:function(){var t=this,n=e("#order_no").val();n||(n=r("order_no")),n&&t.checkOrderPay(n);var a="",i="",c="";e("#product_id").size()>0&&(a=e("#product_id").val(),i=e("#address_id").val(),c=e("#product_id").attr("gift-id")),t.order_no=n,e(".js-store-pay").on("click",function(){var n=e(".agreement_checkbox");if(!n.is(":checked"))return o.showTip("请先同意店铺合同协议书！",3e3,"error"),!1;o.showLoad(!0,!0);window.clearInterval(t.payInterval);var r={};if(t.order_no&&(r.order_no=t.order_no),a){if(!i)return o.showTip("请先添加地址",3e3,"error"),!1;r.product_id=a,r.gift_id=c}e.ajaxPost("/api/order/store",r,function(e){if("Success"==e.code){if(e.data&&e.data.is_pay&&"1"==e.data.is_pay)return window.location.href="/checkout/store/success/"+t.order_no,!0;var n=e.data.order_no;t.checkPay(n),n&&(t.pushState(n),t.order_no=n),o.showLoad(!0),e.data.is_weixin?t.wxPay(e):"undefined"!=typeof e.data.mweb_url&&(window.location.href=e.data.mweb_url)}})}),e(document).on("click",".js-show-store-agreement",function(){var n=e("#store-agreement-template").html();o.init({content:n,close:!1,class_name:"layer-store-agreement",position:"top"}),t.pushAgreementState()}),e(window).on("popstate",function(t){var n=e(".layer-store-agreement");o.hideLayer(n)})},checkPay:function(e){var t=this,o=1;t.payInterval=setInterval(function(){o++,o>100?window.clearInterval(t.payInterval):t.checkOrderPay(e)},3e3)},pushAgreementState:function(){if(history&&history.pushState){var t=window.location.search;t=e.changeURLArg(t,"link","agreement");var o=window.location.pathname+t+window.location.hash;history.pushState({title:document.title,url:o},document.title,o)}},pushState:function(t){if(location.hash="order_no="+t,!is_weixin&&history&&history.pushState){var o=window.location.search;"undefined"!=typeof t&&t&&(o=e.changeURLArg(o,"order_no",t));var n=window.location.pathname+o+window.location.hash;history.pushState({title:document.title,url:n},document.title,n)}},wxPay:function(e){var t=this,o=e.data,n=e.data.order_no;wx.config({appId:o.appId,timestamp:o.timestamp,nonceStr:o.nonceStr,signature:o.paySign,jsApiList:["chooseWXPay"]});var a={appId:o.appId,timestamp:o.timestamp,nonceStr:o.nonceStr,package:o.package,signType:o.signType,paySign:o.paySign,success:function(){t.checkOrderPay(n)},cancel:function(e){window.location.reload()},complete:function(){window.location.reload()}};wx.ready(function(){wx.chooseWXPay(a)})},checkOrderPay:function(t){var o=this;e.ajaxPost("/api/order/checkStoreOrderPay",{order_no:t},function(e){"Success"==e.code&&("undefined"!=typeof o.payInterval&&window.clearInterval(o.payInterval),window.location.href="/checkout/store/success/"+t)})}};"function"==typeof c.init&&e(function(){c.init()})});