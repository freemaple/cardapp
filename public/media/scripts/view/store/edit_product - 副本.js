require(["zepto","base","mylayer","validate"],function(e,i,r,a){var t={init:function(){var i=this;new FormValidator("save-store-product-form",i.productFormRule,function(a,t){var o=e(t.target);if(o.find(".errormsg").html(""),a.length>0)return i.showValidatorError(a,o),r.showTip("请检查您填写的数据",3e3,"error"),!1;var s=(o.serializeObject(),new FormData(o[0])),d=e(".sku-list-item"),c=e(".color_checked:checked"),n=e(".size_checked:checked");if(0==d.size())return r.showTip("请添加规格！",3e3,"error"),!1;var u=[],l=!0;if(d.each(function(){var i=e(this),a={},t=i.find(".sku_id").val(),o=i.find(".sku_size").val(),s=parseFloat(i.find(".sku_price").val()),d=parseFloat(i.find(".sku_market_price").val()),p=i.find(".sku_shipping").val(),m=i.find(".sku_stock").val(),f=i.find(".sku_image"),g=f.attr("data-image-path");if(s<=0)return r.showTip("对不起活动价要大于0",3e3,"error"),l=!1,!1;if(s>d)return r.showTip("对不起活动价要小于原价",3e3,"error"),l=!1,!1;if(m<0)return r.showTip("对不起库存要大于等于0",3e3,"error"),l=!1,!1;var a={sku_id:t,price:s,market_price:d,shipping:p,stock:m};if(c.size()>0){var h=i.find(".sku_color").val();if(""==h)return r.showTip("请输入颜色！",3e3,"error"),l=!1,!1;a.color=h}if(n.size()>0){var o=i.find(".sku_size").val();if(""==o)return r.showTip("请输入规格！",3e3,"error"),l=!1,!1;a.size=o}var v=i.find(".sku_color"),h=v.val();"block"==v.css("display")&&""!=h&&(a.color=h);var _=i.find(".sku_size"),o=_.val();"block"==_.css("display")&&""!=o&&(a.size=o),g&&(a.image_path=g),u.push(a)}),!l)return!1;s.append("skus",JSON.stringify(u));r.showLoad(!0);e.ajax({url:"/api/store/saveProduct",type:"POST",data:s,processData:!1,contentType:!1,success:function(i){"Success"==i.code?(r.showTip(i.message,3e3,"success"),window.location.href="/account/store"):(r.hideLoad(),e.showRequestError(i))},error:function(i){r.hideLoad(),e.showRequestError(i)}})});e(".save-store-product-form").on("submit",function(){return!1}),e(document).on("click",".js-add-product-image",function(){var i=e(".js-product-image-list .product-image-item").size();return i>=10?(r.showTip("对不起,图片最多只能上传10张！",3e3,"error"),!1):void e(".product-image-upload-file").click()}),e(".product-image-upload-file").on("change",function(a){var t=e(".product-image-upload-form"),s=e(this);try{var d=s[0].files;if(d&&d.length>0){if(!d[0].type||e.inArray(d[0].type,["image/png","image/gif","image/jpg","image/jpeg"])==-1)return r.showTip(o.upload_image_format_tip,5e3,"error"),!1;if(d[0].size){var c=d[0].size/1048576;if(c>5)return r.showTip(o.upload_maximum_tip,5e3,"error"),!1}}i.productImageUload(t)}catch(e){}}),e(".js-add-description-image").on("click",function(){var i=e(".product-image-item").size();return i>=10?(r.showTip("对不起,图片最多只能上传10张！",3e3,"error"),!1):void e(".description-image-upload-file").click()}),e(".description-image-upload-form").on("change",function(a){var t=e(this),s=a||window.event,d=e(s.target||s.srcElement);if(!d.hasClass("description-image-upload-file"))return!0;try{var c=d[0].files;if(c&&c.length>0){if(!c[0].type||e.inArray(c[0].type,["image/png","image/gif","image/jpg","image/jpeg"])==-1)return r.showTip(o.upload_image_format_tip,5e3,"error"),!1;if(c[0].size){var n=c[0].size/1048576;if(n>5)return r.showTip(o.upload_maximum_tip,5e3,"error"),!1}}var u=c[0],l=new FileReader;l.readAsDataURL(u),l.onload=function(r){var a=this.result,t=e(".js-description-image-list .product-image-item").size(),o=d.clone(),s=i.random()+t;o.attr("id","product_image_file_"+s).removeClass("description-image-upload-file"),e(".product-description-image-file").append(o);var c=e("#product-image-template"),n=[{image:a,file_id:s}],u=e.tmeplate(c,n);e(".js-add-description-image").before(u)};var p=t.find("input[type=file]");p.after(p.clone().val("")),p.remove()}catch(e){}}),e(".js-remove-product-image").on("click",function(){var i=e(this).attr("data-product-id"),r=e(this).attr("data-id"),a=e(this).closest(".product-image-item"),t=a.attr("data-file-id");t&&e("#product_image_file_"+t).remove(),r&&e.ajaxPost("/api/store/removeProductImage",{product_id:i,product_image_id:r},function(e){"Success"==e.code&&window.location.reload()})}),e(document).on("click",".sku_image",function(){current_sku_image=e(this);var i=e("#product-image-list-template").html(),a=e(".js-product-image-list").html();r.init({content:i,close:!1,class_name:"layer-product-image-list",position:"center",success:function(){}}),e(".product-image-list-box").find(".product-image-list").html(a),e(".product-image-list-box").find(".product-image-list").html(a)}),e(document).on("click",".product-image-list-box .product-image-item",function(){var i=e(this).find("img").attr("src");current_sku_image.find("img").attr("src",i);var a=e(this).attr("data-image-path"),t=e(".layer-product-image-list");r.hideLayer(t),current_sku_image.attr("data-image-path",a)}),e(".attributes_checked").on("click",function(){var i=e(this).attr("data-value");if(e(this).is(":checked"))"color"==i&&e(".sku_color_td").show(),"size"==i&&e(".sku_size_td").show();else{if(0==e(".attributes_checked:checked").size())return!1;"color"==i&&e(".sku_color_td").hide(),"size"==i&&e(".sku_size_td").hide()}}),e(".add_sku").on("click",function(){var i=e(".sku-list-item").first().clone();if(0==i.size()){var r=e("#sku-item-template").html();e(".sku-list-box").append(r)}else i.find(".sku_id").val(""),e(".sku-list-box").append(i)}),e(document).on("click",".js-remove-sku-item",function(){if(1==e(".sku-list-item").size())return r.showTip("至少一个规格属性！"),!1;var i=e(this).closest(".sku-list-item");if(i){var a=i.find(".sku_id").val();if(a){var t=e(this).attr("data-product-id");r.showConfirm("您确认删除此规格？",function(){e.ajaxPost("/api/store/deleteProductSku",{product_id:t,product_sku_id:a},function(){"Success"==result.code?i.remove():result.message&&r.showTip(result.message,3e3,"error")})})}else i.remove()}})},random:function(){var e=parseInt((new Date).getTime()/1e3),i=Math.floor(1e5*Math.random());return e+""+i},productFormRule:[{name:"name",rules:"required|max_length[50]",message:{required:"请输入产品名称！"}},{name:"category_id",rules:"required",message:{required:"请选择分类！"}},{name:"description",rules:"required",message:{required:"请输入描述！"}},{name:"integral_pay",rules:"required",message:{required:"请选择是否接受有赏积分支付"}}],showValidatorError:function(i,r){for(var a=0,t=i.length;a<t;a++){var o=e(i[a].element);0==o.next(".errormsg").size()&&o.after('<div class="errormsg"></div>'),o.next(".errormsg").html(i[a].message)}var s=r.offset().top;window.scrollTo(0,s)},productImageUload:function(i){var a=this,t=new FormData(i[0]);r.showLoad(),e.ajax({url:"/api/store/addProductImage",type:"POST",data:t,processData:!1,contentType:!1,success:function(t){if(r.hideLoad(),a.uploadCallback(i),"Success"==t.code){var o=e("#product-image-template"),s=[{image_id:t.data.image_id,image:t.data.image_link,image_path:t.data.image_path}],d=e.tmeplate(o,s);e(".js-add-product-image").before(d)}else e.showRequestError(t)},error:function(t){r.hideLoad(),a.uploadCallback(i),e.showRequestError(t)}})},descriptionImageUload:function(){var i=this,a=new FormData(form[0]);r.showLoad(),e.ajax({url:"/api/store/addProductImage",type:"POST",data:a,processData:!1,contentType:!1,success:function(a){r.hideLoad(),i.uploadCallback(form),"Success"==a.code?window.location.reload():e.showRequestError(a)},error:function(a){r.hideLoad(),i.uploadCallback(form),e.showRequestError(a)}})},productVideoUload:function(i){var a=this,t=new FormData(i[0]);r.showLoad(),e.ajax({url:"/api/store/editProductVideo",type:"POST",data:t,processData:!1,contentType:!1,success:function(t){r.hideLoad(),a.uploadCallback(i),"Success"==t.code?window.location.reload():e.showRequestError(t)},error:function(t){r.hideLoad(),a.uploadCallback(i),e.showRequestError(t)}})},uploadCallback:function(e){var i=e.find("input[type=file]");i.after(i.clone().val("")),i.remove()}},o={upload_image_format_tip:"请选择png、jpg、jpeg格式图片！",upload_maximum_tip:"图片文件不能超过5M"};"function"==typeof t.init&&e(function(){t.init()})});